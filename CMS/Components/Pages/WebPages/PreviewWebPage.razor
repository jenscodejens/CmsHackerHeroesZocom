@page "/webpages/previewpage/{webPageId:int}"

@using CMS.Components.Pages.ContentPages
@using CMS.Components.BlazorComponents
@using CMS.Shared
@using CMS.Data
@using CMS.Models
@using CMS.Entities
@using CMS.Services
@using BlazorBootstrap
@using System.Text.Json
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@rendermode InteractiveServer
@inject VisitorCounterService VisitorCounterService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider


<Breadcrumbs Crumbs="@(new List<(string, string)>
    {
        ("Hem", "/"),
        //("Websites", "/websites"),
        ("Webbsidor", $"/webpages?websiteid={WebSiteId}"),
        ("Förhandsgranskning", $"/webpages/previewpage/{WebPageId}")
    })" />

<h3>Förhandsgranskning Webbsida</h3>

@if (contentList == null)
{
    <p>Laddar...</p>
}
else if (contentList.Count == 0)
{
    <p>Inget innehåll tillgängligt för denna webbsida.</p>
}
else
{ 
    <Offcanvas @ref="offcanvas"
               title="Redigera ordning">
        <BodyTemplate>
            <CascadingValue Value="contentList">
                <DragAndDropMoveContent />
            </CascadingValue>   
            <div class="mt-3">
                <Button Color="ButtonColor.Success" @onclick="OnHideOffcanvasClick">Klar</Button>
            </div>
        </BodyTemplate>
    </Offcanvas>

    <Button Color="ButtonColor.Primary" @onclick="OnShowOffcanvasClick">Redigera ordning</Button>

    @foreach (var content in contentList)
    {
        <div class="content-preview"> 
            <ContentPreview ContentId="@content.ContentId" />
        </div>
    }

}

<p>Denna sida har besökts @VisitCount gånger.</p>

@code {
    [Parameter] public int WebPageId { get; set; }

    private List<Content> contentList;
    private int VisitCount { get; set; }
    private string CurrentPageUrl => NavigationManager.Uri;
    private int WebSiteId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var dbContext = DbContextFactory.CreateDbContext();

        // Load and sort content items associated with the specified WebPageId by RenderingOrderPosition
        contentList = await dbContext.Contents
            .Where(c => c.WebPageId == WebPageId)
            .OrderBy(c => c.RenderingOrderPosition) // Order by RenderingOrderPosition
            .ToListAsync();

        // Get the WebSiteId associated with this WebPage
        var webPage = await dbContext.WebPages.FirstOrDefaultAsync(wp => wp.WebPageId == WebPageId);
        if (webPage != null)
        {
            WebSiteId = webPage.WebSiteId;

            // Check if the user is logged in
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity.IsAuthenticated)
            {
                // Only increment the visit count if the user is not logged in
                await VisitorCounterService.IncrementPageVisitAsync(WebSiteId, CurrentPageUrl);
            }

            // Get the updated visit count for this page
            VisitCount = await VisitorCounterService.GetPageVisitCountAsync(WebSiteId, CurrentPageUrl);
        }
    }
    private Offcanvas offcanvas = default!;

    private async Task OnShowOffcanvasClick() => await offcanvas.ShowAsync();

    private async Task OnHideOffcanvasClick() => await offcanvas.HideAsync();
}



